extends ../layout.pug
block extrahead 
  link(href='/static/slickgrid/slick.grid.css' rel='stylesheet')
  link(href='/static/slickgrid/slick-default-theme.css' rel='stylesheet')
  link(href='/static/slickgrid/controls/slick.pager.css' rel='stylesheet')
  link(href='/static/jquery-ui-1.13.1/jquery-ui.min.css' rel='stylesheet')
  link(href='/static/jquery-ui-1.13.1/jquery-ui.theme.min.css' rel='stylesheet')
  script(type='text/javascript' src='/static/jquery-ui-1.13.1/jquery-ui.min.js')
  script(type='text/javascript' src='/static/slickgrid/lib/jquery.event.drag-2.3.0.js')
  script(type='text/javascript' src='/static/slickgrid/slick.core.js')
  script(type='text/javascript' src='/static/slickgrid/slick.grid.js')
  script(type='text/javascript' src='/static/slickgrid/slick.dataview.js')
  script(type='text/javascript' src='/static/slickgrid/controls/slick.pager.js')
  script(type='text/javascript' src='/static/slickgrid/plugins/slick.rowmovemanager.js')
  script(type='text/javascript' src='/static/slickgrid/plugins/slick.rowselectionmodel.js')
block body 
  #grid-container.col-12
    #heap-objects-by-size(style='height: 100%;')
    #pager(style='height: 20px;')
  script(type='text/javascript').
    var columns = [
      {id: 'size', name: 'Size', field: 'size',
      sortable: true,
      minWidth: 50, maxWidth: 200,
      cssClass: 'text-right'},
      {id: 'count_all', name: 'Count (all)', field: 'count_all',
      sortable: true,
      minWidth: 100, maxWidth: 200,
      cssClass: 'text-right'},
      {id: 'count_live', name: 'Count (live)', field: 'count_live',
      sortable: true,
      minWidth: 100, maxWidth: 200,
      cssClass: 'text-right'},
      {id: 'bytes_all', name: 'Bytes (all)', field: 'bytes_all',
      sortable: true,
      minWidth: 100, maxWidth: 240,
      cssClass: 'text-right'},
      {id: 'bytes_live', name: 'Bytes (live)', field: 'bytes_live',
      sortable: true,
      minWidth: 100, maxWidth: 240,
      cssClass: 'text-right'},
    ];
    var options = {
      enableCellNavigation: true,
      enableColumnReorder: false,
      autoExpandColumns: true
    };
    var data = [];
    var dataView = new Slick.Data.DataView({ inlineFilters: true });
    var grid = new Slick.Grid("#heap-objects-by-size", dataView, columns, options);
    grid.setSelectionModel(new Slick.RowSelectionModel());
    var pager = new Slick.Controls.Pager(dataView, grid, $("#pager"));
    grid.onSort.subscribe(function(e, args) {
      var comparer = function(a, b) {
        return (a[args.sortCol.field] > b[args.sortCol.field]) ? 1 : -1;
      };
      dataView.sort(comparer, args.sortAsc);
    });
    dataView.onRowCountChanged.subscribe(function (e, args) {
      grid.updateRowCount();
      grid.render();
    });
    dataView.onRowsChanged.subscribe(function (e, args) {
      grid.invalidateRows(args.rows);
      grid.render();
    });
    dataView.beginUpdate();
    dataView.setItems(data);
    dataView.endUpdate();
    function resizeGridContainer() {
      $("#grid-container").height(
        $(window).height() -
        $("#navbar").outerHeight() -
        $("#page-header").outerHeight() - 105
      );
      grid.resizeCanvas();
    }
    resizeGridContainer();
    $(window).resize(resizeGridContainer);
    $.getJSON('/api/session/#{session.key}/heap_size', function(response) {
      dataView.beginUpdate();
      dataView.setItems(response);
      dataView.endUpdate();
    });

